<script>
    new Vue({
      el: '#app',
      data() {
        return {
          allSurahs: [],
          detail: {},
          ayats: [],
          loading: false,
          loading2: false,
          audioUrl: '',
          surahAudio: null,
          surahAudioPlaying: false,
          surahAudioCurrent: 0,
          surahAudioDuration: 0,
          currentAudio: null,
          currentAudioIndex: null,
          isPlaying: false,
          copiedAyats: {},
          lastRead: null,
          bookmarkedSurahs: {},
          showFavorites: false,
          searchQuery: '',
          currentPage: 1,
          itemsPerPage: 10,
          showVoicePopup: false,
          voiceText: ''
        }
      },
      computed: {
        filteredSurahs() {
          let list = this.allSurahs;
          if (this.showFavorites) list = list.filter(s => this.isSurahBookmarked(s.nomor));
          if (this.searchQuery) {
            const q = this.searchQuery.toLowerCase().replace(/[\s-]/g, '');
            list = list.filter(s =>
              [s.nama_latin, s.nama, s.arti]
                .some(val => val.toLowerCase().replace(/[\s-]/g, '').includes(q))
            );
          }
          return list;
        },
        totalPages() { return Math.ceil(this.filteredSurahs.length / this.itemsPerPage); },
        paginatedSurahs() {
          const start = (this.currentPage - 1) * this.itemsPerPage;
          return this.filteredSurahs.slice(start, start + this.itemsPerPage);
        },
        currentIndex() { return this.filteredSurahs.findIndex(s => s.nomor == this.detail.nomor); },
        hasPrev() { return this.currentIndex > 0; },
        hasNext() { return this.currentIndex >= 0 && this.currentIndex < this.filteredSurahs.length - 1; }
      },
      methods: {
        refreshPage() { window.location.reload(); },
        padNumber(n, d) { return n.toString().padStart(d, '0'); },
        getDetail(n) {
          this.loading2 = true;
          this.$http.get(`https://equran.id/api/surat/${n}`)
            .then(r => {
              const res = r.body;
              this.detail = { nomor: res.nomor, nama: res.nama, asma: res.nama_latin, arti: res.arti, type: res.tempat_turun, keterangan: res.deskripsi || "" };
              this.ayats = (res.ayat || []).map(a => ({
                nomor: a.nomor,
                ar: a.ar,
                tr: a.tr,
                id: a.idn,
                audio: `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${this.padNumber(n,3)}${this.padNumber(a.nomor,3)}.mp3`
              }));
              this.audioUrl = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${n}.mp3`;
              this.initSurahAudio();
              this.loading2 = false;
              this.$nextTick(() => this.initSelect2());
            })
            .catch(e => { console.error('getDetail error', e); this.loading2 = false; });
        },
        openDetailModal(n) { this.getDetail(n); $('#detailModal').modal('show'); },
        initSurahAudio() {
          if(this.surahAudio) this.surahAudio.pause();
          this.surahAudio = new Audio(this.audioUrl);
          this.surahAudio.addEventListener('loadedmetadata', () => { this.surahAudioDuration = this.surahAudio.duration; });
          this.surahAudio.addEventListener('timeupdate', () => { this.surahAudioCurrent = this.surahAudio.currentTime; });
          this.surahAudio.addEventListener('ended', () => { this.surahAudioPlaying = false; });
        },
        toggleSurahAudio() {
          if (!this.surahAudio) return;
          if(this.surahAudioPlaying){ this.surahAudio.pause(); this.surahAudioPlaying = false; }
          else { this.surahAudio.play(); this.surahAudioPlaying = true; }
        },
        rewindSurahAudio(){ if(this.surahAudio) this.surahAudio.currentTime = Math.max(0, this.surahAudio.currentTime - 5); },
        forwardSurahAudio(){ if(this.surahAudio) this.surahAudio.currentTime = Math.min(this.surahAudioDuration, this.surahAudio.currentTime + 5); },
        seekSurahAudio(e){ if(this.surahAudio) this.surahAudio.currentTime = e.target.value; },
        formatTime(sec){ const m = Math.floor(sec/60), s = Math.floor(sec % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; },
        togglePlay(item, idx) {
          if (this.currentAudio && this.currentAudioIndex === idx) {
            this.isPlaying ? (this.currentAudio.pause(), this.isPlaying = false) : (this.currentAudio.play(), this.isPlaying = true);
          } else {
            if (this.currentAudio) this.currentAudio.pause();
            this.currentAudio = new Audio(item.audio);
            this.currentAudioIndex = idx; this.isPlaying = true;
            this.currentAudio.onended = () => {
              const next = idx + 1;
              next < this.ayats.length ? this.togglePlay(this.ayats[next], next) : (this.isPlaying = false, this.currentAudio = null, this.currentAudioIndex = null);
            };
            this.currentAudio.play();
            const t = document.getElementById(`ayat-${idx+1}`);
            if(t) t.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        },
        copyAyat(idx, item) {
          const text = `Ayat ${idx}\nArab: ${item.ar}\nLatin: ${item.tr}\nTerjemahan: ${item.id}`;
          navigator.clipboard.writeText(text).then(() => {
            this.$set(this.copiedAyats, item.nomor, true);
            setTimeout(() => this.$delete(this.copiedAyats, item.nomor), 1000);
          });
        },
        shareAyat(platform, item) {
          const text = `${item.ar}\n\n${item.id}\n\n(Dibagikan dari Al-Qur'an Digital)`;
          if (platform === 'whatsapp') window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
          else if (platform === 'facebook') window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://example.com')}&quote=${encodeURIComponent(text)}`, '_blank');
          else if (platform === 'instagram') window.open('https://instagram.com/', '_blank');
        },
        initSelect2() {
          $('#ayatSelect').select2({
            placeholder: 'Pilih ayat...',
            allowClear: true,
            data: this.ayats.map(a => ({ id: a.nomor, text: `Ayat ${a.nomor}: ${a.ar.substring(0,20)}...` }))
          });
          $('#ayatSelect').on('change', () => {
            const val = $('#ayatSelect').val();
            if(val) document.getElementById(`ayat-${val}`).scrollIntoView({ behavior: "smooth", block: "start" });
          });
        },
        isAyatBookmarked(s, a) { return this.lastRead && this.lastRead.surahNumber === s && this.lastRead.ayatNumber === a; },
        toggleAyatBookmark(ayat) {
          this.lastRead = this.isAyatBookmarked(this.detail.nomor, ayat.nomor)
            ? null
            : { surahNumber: this.detail.nomor, surahName: this.detail.asma, ayatNumber: ayat.nomor, ar: ayat.ar, tr: ayat.tr, id: ayat.id };
        },
        goToLastRead() {
          if (this.lastRead) {
            this.getDetail(this.lastRead.surahNumber);
            $('#detailModal').modal('show');
            this.$nextTick(() => {
              setTimeout(() => document.getElementById(`ayat-${this.lastRead.ayatNumber}`).scrollIntoView({ behavior: "smooth", block: "start" }), 500);
            });
          }
        },
        clearLastRead() { this.lastRead = null; },
        isSurahBookmarked(s) { return !!this.bookmarkedSurahs[s]; },
        toggleSurahBookmark(s) {
          this.isSurahBookmarked(s.nomor)
            ? this.$delete(this.bookmarkedSurahs, s.nomor)
            : this.$set(this.bookmarkedSurahs, s.nomor, s);
        },
        filterSurahs() { this.currentPage = 1; },
        previousPage() { if (this.currentPage > 1) this.currentPage--; },
        nextPage() { if (this.currentPage < this.totalPages) this.currentPage++; },
        prevSurah() { if (this.hasPrev) this.getDetail(this.filteredSurahs[this.currentIndex - 1].nomor); },
        nextSurah() { if (this.hasNext) this.getDetail(this.filteredSurahs[this.currentIndex + 1].nomor); },
        toggleShowFavorites() { this.showFavorites = !this.showFavorites; this.currentPage = 1; },
        startVoiceSearch() {
          if (!('webkitSpeechRecognition' in window)) {
            alert('Browser Anda tidak mendukung fitur pencarian suara.');
            return;
          }
          const recognition = new webkitSpeechRecognition();
          recognition.lang = 'id-ID';
          recognition.continuous = false;
          recognition.interimResults = true;
          this.showVoicePopup = true;
          this.voiceText = 'Mendengarkan...';
          document.body.classList.remove('modal-open');
          if (document.querySelector('.modal-backdrop')) document.querySelector('.modal-backdrop').remove();
          recognition.onresult = event => {
            const interim = Array.from(event.results).map(r => r[0].transcript).join('');
            this.voiceText = interim || 'Mendengarkan...';
            if (event.results[0].isFinal) {
              this.searchQuery = event.results[0][0].transcript;
              this.filterSurahs();
              setTimeout(() => {
                this.showVoicePopup = false;
                document.body.classList.remove('modal-open');
                if (document.querySelector('.modal-backdrop')) document.querySelector('.modal-backdrop').remove();
              }, 1000);
            }
          };
          recognition.onend = () => {
            if (this.voiceText === 'Mendengarkan...') {
              this.voiceText = 'Tidak ada suara terdeteksi';
              setTimeout(() => {
                this.showVoicePopup = false;
                document.body.classList.remove('modal-open');
                if (document.querySelector('.modal-backdrop')) document.querySelector('.modal-backdrop').remove();
              }, 1000);
            }
          };
          recognition.onerror = event => {
            this.voiceText = 'Error: ' + event.error;
            setTimeout(() => {
              this.showVoicePopup = false;
              document.body.classList.remove('modal-open');
              if (document.querySelector('.modal-backdrop')) document.querySelector('.modal-backdrop').remove();
            }, 1000);
            console.error('Voice recognition error:', event.error);
          };
          recognition.start();
        }
      },
      mounted() {
        this.loading = true;
        this.$http.get('https://equran.id/api/surat')
          .then(res => { this.allSurahs = res.body; this.loading = false; })
          .catch(err => { console.error('error', err); this.loading = false; });
        $('#detailModal').on('hidden.bs.modal', () => {
          if (this.surahAudio) this.surahAudio.pause();
          if (this.currentAudio) this.currentAudio.pause();
          this.surahAudioPlaying = false;
          this.isPlaying = false;
          this.currentAudio = null;
          this.currentAudioIndex = null;
        });
      }
    });
    </script>
    